<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="baidu-site-verification" content="2XMQAJIGe2" />
	<title>提升数据入Redis的速度</title>
	<meta name="description" content="最近，踩过很多的坑。自己踩过，和团队一起也踩过。这里记录一个小坑，如果大家遇到了应该也会有共鸣的。">
	
		<link rel="stylesheet" href="http://7xjddt.com1.z0.glb.clouddn.com/monokai.css">
		<link rel="stylesheet" href="http://7xjddt.com1.z0.glb.clouddn.com/bootstrap.min.css">
		<link rel="stylesheet" href="http://7xjddt.com1.z0.glb.clouddn.com/bootstrap-theme.min.css">
		<link rel="stylesheet" href="http://7xjddt.com1.z0.glb.clouddn.com/all.css">
		<link rel="stylesheet" href="http://7xjddt.com1.z0.glb.clouddn.com/font-awesome.min.css"/>
	
	<link rel="alternate" type="application/rss+xml" title="searchpcc - 一个正在老去的90后程序员" href="http://searchp.cc/feed.xml" />
	
		<link rel="icon" href="http://7xjddm.com1.z0.glb.clouddn.com/favicon.ico" type="image/x-icon">
	
</head>


<body>
<!--引入导航-->
<header>
	<!--导航菜单-->
	<nav class="navbar header navbar-fixed-top">
		<div class="container-fluid">
			<span class="navbar-brand"><a href="/">
				
					<img id="headerimg" src="http://7xjddm.com1.z0.glb.clouddn.com/header.jpeg"></a>
				
			</span>
			<div class="navbar-header">
				<button type="button" class ="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="/">searchpcc</a>
			</div>
			<div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
					<li><a href="/archive/">归档</a></li>
					<li><a href="/category/">分类</a></li>
					<li><a href="/series/">连载</a></li>
					<li><a href="/resume/">简历</a></li>
					<li><a href="/about/">关于</a></li>
				</ul>
			</div>
		</div>
	</nav><!-- 导航菜单结束-->
</header>


<!--主体内容-->
<div class="page-content">
    <div class="container-fluid">
    	<div class="row">
                <div class="col-md-offset-2 col-md-8  main-content">
                	<div  id="searchpcc">
						<a href="/"><img id="abouthead" src="/assets/images/about.png"></a>
						<p>一个正在老去的90后程序员 --searchpcc</p>
                	</div>
                </div>
        </div>

        <div class="row">
            <div class="col-md-offset-2 col-md-8  main-content">
                <div class="post">
	<!--文章标题和说明-->
	<header>
		<!--文章名称-->
		<h1 class="post-title">提升数据入Redis的速度</h1>
		<!--文章描述，时间和分类-->
		<p class="desc">
			<i class="fa fa-calendar"></i>
			2015/08/13 &nbsp;&nbsp;
			<i class="fa fa-folder-open-o fa-fw"></i>
			<a href="/category/">php </a>
		</p>
	</header>

	<!--文章内容-->
	<article class="post-content">
		<p>最近，踩过很多的坑。自己踩过，和团队一起也踩过。这里记录一个小坑，如果大家遇到了应该也会有共鸣的。</p>

<h2 id="id-section">遇到的问题</h2>

<p>前些日子有一些日志需要处理。日志文件的大写都是10G+，数亿条的。刚开始我解决的思路是这样的：首先用awk+sed将日志清洗一遍，然后用PHP或者Python将日志逐行读取，接着逐行按照特定的格式(key-value或者hash)的格式存入到redis（主从或者集群）之中。</p>

<p>可是，后面一试效率吓死人。我用的是Predis连接集群的方式，存入的格式是hash格式。因为和服务器性能和日志的长度有关系，这里我也没法给出一个时间来。但是，如果按照这个进度来，我们肯定是接受不了的，因为我们的数据是需要在短期内就被用作另一个系统的。</p>

<h2 id="id-section-1">解决的办法</h2>

<p>我们首先想到文件的读取方式是不是有问题。<code>排除了</code></p>

<p>然后我想是不是语言的性能的问题。用Python的方式实现了一遍，提升了一点点，但是效果不是很明显。<code>排除了</code></p>

<p>后面团队中有经验的同事，想到了一种Redis事务的方法。<code>采用了</code></p>

<p><strong>php Predis使用的方式</strong></p>

<p>Predis是PHP连接集群的一个类库。到目前为止大概是PHP使用redis3.0 cluster唯一的方式。</p>

<pre><code class="language-php">// ......省略引入类库代码
Predis\Autoloader::register();
$client = new Predis\Client(array('tcp://192.168.0.8:6379','tcp://192.168.0.8:6380,array('cluster'=&gt;'redis'));
// 这句话很重要。获取集群的map表
$client-&gt;set('fuck', 'you');
$redis = $client-&gt;pipeline();
$count = 0;
$perNum = 0;
if ($handle) {
    while(($buffer = fgets($handle, 4096)) !== false) {
            $aa = trim($buffer[0]);
            $bb = trim($buffer[1]);
            try {
                $redis-&gt;setnx($aa, $bb);
                $count++;
                if($count % 1000 == 0) {
                    $redis-&gt;execute();
                    // 这两句也很重要。注销对象，并且创建新的空对象。
                    unset($redis);
                    $redis = $client-&gt;pipeline();
                    $perNum = 0;
                }
                $perNum++;
            } catch(Exception $e) {
                 continue;
            }
        }
    }
    // 处理文件末尾不足1000的部分。
   if($perNum &gt; 0) {
        $redis-&gt;execute();
    }
}
</code></pre>

<p><strong>php redis使用事务的方式</strong></p>

<p>php redis处理事务的方式比较简单。因为网上使用这种方式都比较多。主要的函数就两个。multi() 和 exec()。原理是先打包，然后一次性执行。实现的方式和上述方式相仿。这里不赘述，注意函数名称的变化就好。</p>

<h2 id="id-section-2">总结</h2>

<p>redis3.0 cluster的坑很多。连接redis的phpredis和Predis的坑也很多。另外:目前redis3.0真的不是很稳定，能不用集群的方式用代理的方式替代就用稳定的代理方式吧。我们私下也在写自己的代理，尽管这周集群运转比较正常。</p>

<p>那天看到亚一程在微博吐槽phpredis源码，并且正在重构。后面一想：同样是人差距还真的挺大的。</p>

<p>（全文完）</p>


	</article>

	<!--上下翻页-->
	<ul class="pager pagination-sm">
		<!--前一页-->
		
		<li class="previous">
			<a href="/20150811.html" title="狂刷Git技能">&larr; Previous</a>
		</li>
		

		<!--下一页-->
		
		<li class="next">
			<a href="/20150820.html" title="chrome插件之vimium">Next &rarr;</a>
		</li>
		
	</ul>
	<!--引入评论-->
	<div id="disqus_thread"></div>
<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES * * */
	var disqus_shortname = 'searchpcc';
	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function() {
	var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>
	Please enable JavaScript to view the
	<a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
</div>

            </div>
        </div>
    </div>
</div>
<!--引入结尾-->
<!--页脚-->
<footer>
   	<p>Copyright  ©  2015  All Rights Reserved <script type="text/javascript">
	var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
	document.write(unescape("%3Cspan id='cnzz_stat_icon_1255277077'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1255277077%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));
</script></p>
 	<div class="scroll-top hidden-xs"><i class="fa fa-arrow-circle-up"></i></div>
</footer>

<!--引入脚本-->
<!--所有脚本文件的引入-->

	<script src="http://7xjddx.com1.z0.glb.clouddn.com/highlight.pack.js"></script>
	<script src="http://7xjddx.com1.z0.glb.clouddn.com/jquery.min.js"></script>
	<script src="http://7xjddx.com1.z0.glb.clouddn.com/bootstrap.min.js"></script>
	<script src="http://7xjddx.com1.z0.glb.clouddn.com/all.js"></script>

<script> hljs.initHighlightingOnLoad(); </script>

</body>
</html>
